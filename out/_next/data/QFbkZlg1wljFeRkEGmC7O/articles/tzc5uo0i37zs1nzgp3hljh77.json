{"pageProps":{"article":{"id":257,"documentId":"tzc5uo0i37zs1nzgp3hljh77","title":"DynamoDB Scan vs Query: パフォーマンスとコストの比較","content":"弊社では、API Gateway + Lambda + DynamoDBを利用したサーバーレスアーキテクチャでの開発を多く行っています。\n\nその中で、度々パフォーマンス問題が発生する事がありますが、特にDynamoDBのScan操作に起因するケースが目立ちます。\n\nこの記事では、**Scan**と**Query**のパフォーマンスとコストの違いについて、実際のデータを用いた検証結果をもとに解説します。\n\n---\n\n## 事前準備\n\nDynamoDBに10万件のサンプルデータを投入し、ScanとQueryの動作を比較します。\n\n### データ準備手順\n\n1. **CSVからデータ投入**:\n    \n    AWS公式サンプルリポジトリ [aws-samples/csv-to-dynamodb](https://github.com/aws-samples/csv-to-dynamodb) を利用。\n    \n    投入手順は [こちらの記事](https://dev.classmethod.jp/articles/csv-import-to-dynamodb-table/) を参照。\n    \n2. **データ件数確認**:\nDynamoDB CLIを用いてデータ件数を確認します。\n    \n    ```bash\n    aws dynamodb scan --table-name test_datas --select COUNT\n    \n    ```\n    \n    結果:\n    \n    ```json\n    {\n        \"Count\": 100000,\n        \"ScannedCount\": 100000,\n        \"ConsumedCapacity\": null\n    }\n    ```\n    \n    10万件のデータが投入されました。\n    \n\n---\n\n## 実験1: Scan\n\n### 実装コード\n\n以下のLambda関数を使用してDynamoDBのScan操作を実行します。\n\n```python\nimport boto3\nfrom boto3.dynamodb.conditions import Attr\n\ndef lambda_handler(event, context):\n    table_name = 'test_datas'\n    region = 'us-east-1'\n\n    dynamodb = boto3.resource('dynamodb', region_name=region)\n    table = dynamodb.Table(table_name)\n\n    filter_expression = Attr('Country').eq('Australia')\n\n    try:\n        options = {\n            'FilterExpression': filter_expression,\n            'Limit': 1000,\n            'ReturnConsumedCapacity': 'TOTAL'\n        }\n        while True:\n            response = table.scan(**options)\n            print(response['Items'])\n            print(response['ConsumedCapacity'])\n            next_token = response.get('LastEvaluatedKey', None)\n            print(next_token)\n\n            if next_token:\n                options['ExclusiveStartKey'] = next_token\n            else:\n                break\n\n        return {'statusCode': 200}\n    except Exception as e:\n        print('エラー:', e)\n        return {'statusCode': 500, 'body': 'サーバーエラーが発生しました'}\n\n```\n\n### 実行結果\n\nウォームスタートでの実行結果:\n\n- **実行時間**: 約5秒\n- **消費キャパシティユニット**: 62\n\nログの一部:\n\n```json\nFunction Logs:\n'3/30/15', 'Region': 'Australia and Oceania', 'TotalRevenue': '58517.76', 'ShipDate': '5/8/15', 'SalesChannel': 'Offline', 'UnitCost': '6.92', 'uuid': '757149684', 'TotalCost': '43402.24'}, {'ItemType': 'Snacks', 'TotalProfit': '206885.28', 'UnitsSold': '3752', 'UnitPrice': '152.58', 'Country': 'Australia', 'OrderPriority': 'C', 'OrderDate': '4/19/10', 'Region': 'Australia and Oceania', 'TotalRevenue': '572480.16', 'ShipDate': '6/5/10', 'SalesChannel': 'Offline', 'UnitCost': '97.44', 'uuid': '340443837', 'TotalCost': '365594.88'}, {'ItemType': 'Snacks', 'TotalProfit': '313912.02', 'UnitsSold': '5693', 'UnitPrice': '152.58', 'Country': 'Australia', 'OrderPriority': 'M', 'OrderDate': '9/12/12', 'Region': 'Australia and Oceania', 'TotalRevenue': '868637.94', 'ShipDate': '10/27/12', 'SalesChannel': 'Online', 'UnitCost': '97.44', 'uuid': '892960441', 'TotalCost': '554725.92'}, {'ItemType': 'Meat', 'TotalProfit': '462061.6', 'UnitsSold': '8078', 'UnitPrice': '421.89', 'Country': 'Australia', 'OrderPriority': 'M', 'OrderDate': '8/23/13', 'Region': 'Australia and Oceania', 'TotalRevenue': '3408027.42', 'ShipDate': '8/27/13', 'SalesChannel': 'Offline', 'UnitCost': '364.69', 'uuid': '543180644', 'TotalCost': '2945965.82'}, {'ItemType': 'Beverages', 'TotalProfit': '152559.72', 'UnitsSold': '9742', 'UnitPrice': '47.45', 'Country': 'Australia', 'OrderPriority': 'L', 'OrderDate': '1/27/16', 'Region': 'Australia and Oceania', 'TotalRevenue': '462257.9', 'ShipDate': '2/14/16', 'SalesChannel': 'Offline', 'UnitCost': '31.79', 'uuid': '671733558', 'TotalCost': '309698.18'}]\n{'TableName': 'test_datas', 'CapacityUnits': 28.5}\n{'uuid': '147039830'}\n[{'ItemType': 'Cosmetics', 'TotalProfit': '919076.82', 'UnitsSold': '5286', 'UnitPrice': '437.2', 'Country': 'Australia', 'OrderPriority': 'M', 'OrderDate': '5/12/14', 'Region': 'Australia and Oceania', 'TotalRevenue': '2311039.2', 'ShipDate': '5/31/14', 'SalesChannel': 'Online', 'UnitCost': '263.33', 'uuid': '746805799', 'TotalCost': '1391962.38'}, {'ItemType': 'Vegetables', 'TotalProfit': '273731.68', 'UnitsSold': '4336', 'UnitPrice': '154.06', 'Country': 'Australia', 'OrderPriority': 'L', 'OrderDate': '11/20/15', 'Region': 'Australia and Oceania', 'TotalRevenue': '668004.16', 'ShipDate': '12/21/15', 'SalesChannel': 'Online', 'UnitCost': '90.93', 'uuid': '964156997', 'TotalCost': '394272.48'}, {'ItemType': 'Cosmetics', 'TotalProfit': '734253.01', 'UnitsSold': '4223', 'UnitPrice': '437.2', 'Country': 'Australia', 'OrderPriority': 'C', 'OrderDate': '5/30/10', 'Region': 'Australia and Oceania', 'TotalRevenue': '1846295.6', 'ShipDate': '7/12/10', 'SalesChannel': 'Offline', 'UnitCost': '263.33', 'uuid': '182464730', 'TotalCost': '1112042.59'}, {'ItemType': 'Cosmetics', 'TotalProfit': '398683.91', 'UnitsSold': '2293', 'UnitPrice': '437.2', 'Country': 'Australia', 'OrderPriority': 'C', 'OrderDate': '5/24/15', 'Region': 'Australia and Oceania', 'TotalRevenue': '1002499.6', 'ShipDate': '5/25/15', 'SalesChannel': 'Offline', 'UnitCost': '263.33', 'uuid': '841381347', 'TotalCost': '603815.69'}, {'ItemType': 'Household', 'TotalProfit': '251743.87', 'UnitsSold': '1519', 'UnitPrice': '668.27', 'Country': 'Australia', 'OrderPriority': 'C', 'OrderDate': '1/3/14', 'Region': 'Australia and Oceania', 'TotalRevenue': '1015102.13', 'ShipDate': '1/25/14', 'SalesChannel': 'Online', 'UnitCost': '502.54', 'uuid': '351520287', 'TotalCost': '763358.26'}, {'ItemType': 'Household', 'TotalProfit': '1447485.82', 'UnitsSold': '8734', 'UnitPrice': '668.27', 'Country': 'Australia', 'OrderPriority': 'C', 'OrderDate': '1/29/14', 'Region': 'Australia and Oceania', 'TotalRevenue': '5836670.18', 'ShipDate': '2/2/14', 'SalesChannel': 'Offline', 'UnitCost': '502.54', 'uuid': '391825520', 'TotalCost': '4389184.36'}]\n{'TableName': 'test_datas', 'CapacityUnits': 28.5}\n{'uuid': '690726172'}\n[]\n{'TableName': 'test_datas', 'CapacityUnits': 0.5}\nNone\nEND RequestId: f6e29395-105a-4388-ae4b-a15905769f51\nREPORT RequestId: f6e29395-105a-4388-ae4b-a15905769f51\tDuration: 4904.22 ms\tBilled Duration: 4905 ms\tMemory Size: 128 MB\tMax Memory Used: 77 MB\n```\n\n---\n\n## 実験2: Query\n\n### GSI（グローバルセカンダリインデックス）作成\n\n`Country` を条件にQueryを実行するため、以下の条件でGSIを作成しました。\n\n- **GSI名**: Country-index\n- **パーティションキー**: Country（文字列）\n\n### 実装コード\n\n以下のLambda関数を使用してDynamoDBのQuery操作を実行します。\n\n```python\nimport boto3\nfrom boto3.dynamodb.conditions import Key\n\ndef lambda_handler(event, context):\n    table_name = 'test_datas'\n    region = 'us-east-1'\n\n    dynamodb = boto3.resource('dynamodb', region_name=region)\n    table = dynamodb.Table(table_name)\n\n    key_condition_expression = Key('Country').eq('Australia')\n\n    try:\n        options = {\n            'KeyConditionExpression': key_condition_expression,\n            'Limit': 1000,\n            'ReturnConsumedCapacity': 'TOTAL'\n        }\n        while True:\n            response = table.query(**options)\n            print(response['Items'])\n            print(response['ConsumedCapacity'])\n            next_token = response.get('LastEvaluatedKey', None)\n            print(next_token)\n\n            if next_token:\n                options['ExclusiveStartKey'] = next_token\n            else:\n                break\n\n        return {'statusCode': 200}\n    except Exception as e:\n        print('エラー:', e)\n        return {'statusCode': 500, 'body': 'サーバーエラーが発生しました'}\n\n```\n\n### 実行結果\n\nウォームスタートでの実行結果:\n\n- **実行時間**: 約1.1秒\n- **消費キャパシティユニット**: 16.5\n\nログの一部:\n\n```json\nFunction Logs:\nItemType': 'Fruits', 'TotalProfit': '15115.52', 'UnitsSold': '6272', 'Country': 'Australia', 'UnitPrice': '9.33', 'OrderPriority': 'H', 'OrderDate': '3/30/15', 'Region': 'Australia and Oceania', 'TotalRevenue': '58517.76', 'ShipDate': '5/8/15', 'SalesChannel': 'Offline', 'UnitCost': '6.92', 'uuid': '757149684', 'TotalCost': '43402.24'}, {'ItemType': 'Snacks', 'TotalProfit': '206885.28', 'UnitsSold': '3752', 'Country': 'Australia', 'UnitPrice': '152.58', 'OrderPriority': 'C', 'OrderDate': '4/19/10', 'Region': 'Australia and Oceania', 'TotalRevenue': '572480.16', 'ShipDate': '6/5/10', 'SalesChannel': 'Offline', 'UnitCost': '97.44', 'uuid': '340443837', 'TotalCost': '365594.88'}, {'ItemType': 'Snacks', 'TotalProfit': '313912.02', 'UnitsSold': '5693', 'Country': 'Australia', 'UnitPrice': '152.58', 'OrderPriority': 'M', 'OrderDate': '9/12/12', 'Region': 'Australia and Oceania', 'TotalRevenue': '868637.94', 'ShipDate': '10/27/12', 'SalesChannel': 'Online', 'UnitCost': '97.44', 'uuid': '892960441', 'TotalCost': '554725.92'}, {'ItemType': 'Meat', 'TotalProfit': '462061.6', 'UnitsSold': '8078', 'Country': 'Australia', 'UnitPrice': '421.89', 'OrderPriority': 'M', 'OrderDate': '8/23/13', 'Region': 'Australia and Oceania', 'TotalRevenue': '3408027.42', 'ShipDate': '8/27/13', 'SalesChannel': 'Offline', 'UnitCost': '364.69', 'uuid': '543180644', 'TotalCost': '2945965.82'}, {'ItemType': 'Beverages', 'TotalProfit': '152559.72', 'UnitsSold': '9742', 'Country': 'Australia', 'UnitPrice': '47.45', 'OrderPriority': 'L', 'OrderDate': '1/27/16', 'Region': 'Australia and Oceania', 'TotalRevenue': '462257.9', 'ShipDate': '2/14/16', 'SalesChannel': 'Offline', 'UnitCost': '31.79', 'uuid': '671733558', 'TotalCost': '309698.18'}, {'ItemType': 'Cosmetics', 'TotalProfit': '919076.82', 'UnitsSold': '5286', 'Country': 'Australia', 'UnitPrice': '437.2', 'OrderPriority': 'M', 'OrderDate': '5/12/14', 'Region': 'Australia and Oceania', 'TotalRevenue': '2311039.2', 'ShipDate': '5/31/14', 'SalesChannel': 'Online', 'UnitCost': '263.33', 'uuid': '746805799', 'TotalCost': '1391962.38'}, {'ItemType': 'Vegetables', 'TotalProfit': '273731.68', 'UnitsSold': '4336', 'Country': 'Australia', 'UnitPrice': '154.06', 'OrderPriority': 'L', 'OrderDate': '11/20/15', 'Region': 'Australia and Oceania', 'TotalRevenue': '668004.16', 'ShipDate': '12/21/15', 'SalesChannel': 'Online', 'UnitCost': '90.93', 'uuid': '964156997', 'TotalCost': '394272.48'}, {'ItemType': 'Cosmetics', 'TotalProfit': '734253.01', 'UnitsSold': '4223', 'Country': 'Australia', 'UnitPrice': '437.2', 'OrderPriority': 'C', 'OrderDate': '5/30/10', 'Region': 'Australia and Oceania', 'TotalRevenue': '1846295.6', 'ShipDate': '7/12/10', 'SalesChannel': 'Offline', 'UnitCost': '263.33', 'uuid': '182464730', 'TotalCost': '1112042.59'}, {'ItemType': 'Cosmetics', 'TotalProfit': '398683.91', 'UnitsSold': '2293', 'Country': 'Australia', 'UnitPrice': '437.2', 'OrderPriority': 'C', 'OrderDate': '5/24/15', 'Region': 'Australia and Oceania', 'TotalRevenue': '1002499.6', 'ShipDate': '5/25/15', 'SalesChannel': 'Offline', 'UnitCost': '263.33', 'uuid': '841381347', 'TotalCost': '603815.69'}, {'ItemType': 'Household', 'TotalProfit': '251743.87', 'UnitsSold': '1519', 'Country': 'Australia', 'UnitPrice': '668.27', 'OrderPriority': 'C', 'OrderDate': '1/3/14', 'Region': 'Australia and Oceania', 'TotalRevenue': '1015102.13', 'ShipDate': '1/25/14', 'SalesChannel': 'Online', 'UnitCost': '502.54', 'uuid': '351520287', 'TotalCost': '763358.26'}, {'ItemType': 'Household', 'TotalProfit': '1447485.82', 'UnitsSold': '8734', 'Country': 'Australia', 'UnitPrice': '668.27', 'OrderPriority': 'C', 'OrderDate': '1/29/14', 'Region': 'Australia and Oceania', 'TotalRevenue': '5836670.18', 'ShipDate': '2/2/14', 'SalesChannel': 'Offline', 'UnitCost': '502.54', 'uuid': '391825520', 'TotalCost': '4389184.36'}]\n{'TableName': 'test_datas', 'CapacityUnits': 16.5}\nNone\nEND RequestId: 902e8513-28db-4e25-9a4e-df9cba5f9410\nREPORT RequestId: 902e8513-28db-4e25-9a4e-df9cba5f9410\tDuration: 1158.68 ms\tBilled Duration: 1159 ms\tMemory Size: 128 MB\tMax Memory Used: 82 MB\n```\n\n---\n\n## 比較結果\n\n| 操作方法 | 実行時間 | 消費キャパシティユニット |\n| --- | --- | --- |\n| Scan | 約5秒 | 62 |\n| Query | 約1.1秒 | 16.5 |\n\n### 考察\n\n1. **パフォーマンス**:\nQueryはScanよりも4倍以上高速。指定したパーティションキーに基づいて効率的にデータを取得できるためです。\n2. **コスト効率**:\n消費キャパシティユニットもScanの約4分の1。大量データの操作では大幅なコスト削減が見込めます。\n3. **使用ケース**:\nデータを効率的に取得したい場合や条件検索が必要な場合は**Query**を使用すべき。一方、条件に合致するパーティションキーがない場合や全件検索が必要な場合に限り、**Scan**を検討します。\n\n---\n\n## まとめ\n\nデータ件数10万件の実験結果から、**Query**は**Scan**よりも圧倒的に高速かつ低コストであることが確認できました。\n\n**結論**:\n\n- DynamoDBのパフォーマンス最適化を考えるなら、**Queryを優先的に使用**。\n- 特に、必要なデータに応じたパーティションキーやGSI設計を行うことが重要です。\n\nこれからDynamoDBを使った開発を行う方は、この結果を参考に、効率的なデータ操作を実現してください。\n\n---\n\n","createdAt":"2025-05-19T08:50:57.493Z","updatedAt":"2025-06-05T23:54:12.945Z","publishedAt":"2025-06-05T23:54:12.955Z","docId":"za9s1y1l3ml93qjgosr1vlhy","tags":[{"id":10,"documentId":"cxt2tbnsy05cazm17p3pp1a3","createdAt":"2025-05-19T09:46:58.860Z","updatedAt":"2025-05-19T09:46:58.860Z","publishedAt":"2025-05-19T09:46:58.868Z","name":"AWS"},{"id":12,"documentId":"c3lesvkdvjiq7y5zfx9mx0tu","createdAt":"2025-05-19T09:47:14.973Z","updatedAt":"2025-05-19T09:47:14.973Z","publishedAt":"2025-05-19T09:47:14.980Z","name":"Backend"}],"thumbnail":[{"id":13,"documentId":"i7hnmvhawpdgyops4ew36guj","name":"20250513-09.png","alternativeText":null,"caption":null,"width":1503,"height":844,"formats":{"thumbnail":{"name":"thumbnail_20250513-09.png","hash":"thumbnail_20250513_09_0f6287835c","ext":".png","mime":"image/png","path":null,"width":245,"height":138,"size":14.36,"sizeInBytes":14359,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/thumbnail_20250513_09_0f6287835c.png"},"medium":{"name":"medium_20250513-09.png","hash":"medium_20250513_09_0f6287835c","ext":".png","mime":"image/png","path":null,"width":750,"height":421,"size":57.07,"sizeInBytes":57073,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_09_0f6287835c.png"},"small":{"name":"small_20250513-09.png","hash":"small_20250513_09_0f6287835c","ext":".png","mime":"image/png","path":null,"width":500,"height":281,"size":34.88,"sizeInBytes":34880,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/small_20250513_09_0f6287835c.png"},"large":{"name":"large_20250513-09.png","hash":"large_20250513_09_0f6287835c","ext":".png","mime":"image/png","path":null,"width":1000,"height":562,"size":80.44,"sizeInBytes":80435,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/large_20250513_09_0f6287835c.png"}},"hash":"20250513_09_0f6287835c","ext":".png","mime":"image/png","size":23.72,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/20250513_09_0f6287835c.png","previewUrl":null,"provider":"@strapi/provider-upload-aws-s3","provider_metadata":null,"createdAt":"2025-05-20T07:44:09.283Z","updatedAt":"2025-05-20T07:44:09.283Z","publishedAt":"2025-05-20T07:44:09.284Z"}]}},"__N_SSG":true}