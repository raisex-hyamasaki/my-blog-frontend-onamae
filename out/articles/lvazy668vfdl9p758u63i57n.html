<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>同期処理におけるAWS Lambda関数タイムアウトのハンドリング検討<!-- --> | レイズクロス Tech Blog</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/7d757bdfdfb985a7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7d757bdfdfb985a7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-2c547fd4592db0a6.js" defer=""></script><script src="/_next/static/chunks/framework-e952fed463eb8e34.js" defer=""></script><script src="/_next/static/chunks/main-db60732262e3da6e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b6737859a806843a.js" defer=""></script><script src="/_next/static/chunks/a2bf56a3-f921f321ae1e0e8d.js" defer=""></script><script src="/_next/static/chunks/61-92d26e53a2a7fcf5.js" defer=""></script><script src="/_next/static/chunks/257-c12ad0b16790f4c5.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-7cfc7284c2566c9d.js" defer=""></script><script src="/_next/static/QTcQf_D8J2NMGF1e92-0w/_buildManifest.js" defer=""></script><script src="/_next/static/QTcQf_D8J2NMGF1e92-0w/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-[1024px] mx-auto px-4"><header class="sticky top-0 z-20 bg-white border-b border-gray-200 h-12 flex items-center justify-between px-4"><a class="text-blue-600 no-underline hover:text-gray-600 text-lg font-bold" href="/">📋 レイズクロス Tech Blog</a><div class="flex gap-3"><a href="https://twitter.com/share" target="_blank" rel="noopener noreferrer"><img src="/icons/x.svg" alt="Share on X" class="h-7 w-7"/></a><a href="https://www.facebook.com/sharer/sharer.php" target="_blank" rel="noopener noreferrer"><img src="/icons/facebook.svg" alt="Share on Facebook" class="h-7 w-7"/></a><a href="https://social-plugins.line.me/lineit/share" target="_blank" rel="noopener noreferrer"><img src="/icons/line.svg" alt="Share on LINE" class="h-7 w-7"/></a></div></header><article class="prose prose-slate max-w-none pt-6"><h1 class="text-3xl font-bold border-b pb-2">同期処理におけるAWS Lambda関数タイムアウトのハンドリング検討</h1><div class="text-sm text-gray-500 mb-4">投稿更新日: <!-- -->2025/6/2 8:54:20</div><div class="flex flex-wrap gap-2 mb-4"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">#<!-- -->AWS</span><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">#<!-- -->Backend</span></div><div class="w-full flex justify-center mb-6"><img src="https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_12_449ae1295c.png" alt="サムネイル" class="w-full max-w-[800px] h-auto rounded"/></div><h1>背景</h1>
<p>弊社ではサーバーレスアーキテクチャを活用した開発を進めており、AWS Lambdaも多くのプロジェクトで利用しています。しかし、Lambda関数のタイムアウトが発生した場合のハンドリングが不十分で、サービスの一時的な停止や、顧客体験の低下に繋がる事例が発生しました。本記事では、Lambda関数のタイムアウトに対する適切なハンドリング方法を検討し、より信頼性の高いシステム構築を目指します。</p>
<hr/>
<h1>検証概要</h1>
<ol>
<li><strong>API Gateway + Lambda構成</strong>
<ul>
<li>クライアント(frontend)からのリクエスト時にタイムアウトするケースを想定し、ハンドリングを検討</li>
</ul>
</li>
<li><strong>Lambda関数から同期で他のLambda関数を実行</strong>
<ul>
<li>バックエンドでの実行時にタイムアウトするケースを想定し、ハンドリングを検討</li>
</ul>
</li>
</ol>
<hr/>
<h2>検証1: API Gateway + Lambda構成</h2>
<h3>再現するタイムアウトの設定</h3>
<p>以下のLambda関数を30秒のタイムアウト設定で実装しました。この関数は、45秒間スリープするため確実にタイムアウトが発生します。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> json
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> time
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;=====sleep start=====&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    time</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>sleep</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">45</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;=====sleep end=====&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;body&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> json</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dumps</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Hello from Lambda!&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<h3>実験内容</h3>
<p>この関数をAPI Gatewayで <code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">GET /time-out</code> エンドポイントとして公開し、以下のコマンドでリクエストを実行しました。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-bash" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(207, 82%, 66%)">curl</span><span> https://your.domain/time-out -i
</span></code></pre></div></pre>
<h3>結果</h3>
<p>タイムアウトが発生した場合、以下のレスポンスが返ってきました。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-bash" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>HTTP/2 </span><span class="token" style="color:hsl(29, 54%, 61%)">504</span><span> 
</span><span>date: Sat, 07 Dec </span><span class="token" style="color:hsl(29, 54%, 61%)">2024</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">12</span><span>:51:53 GMT
</span>content-type: application/json
<span>content-length: </span><span class="token" style="color:hsl(29, 54%, 61%)">41</span><span>
</span>x-amzn-requestid: de0b98ff-54cb-46af-acb3-d3d3f08dd189
<!-- -->x-amzn-errortype: InternalServerErrorException
<span>x-amz-apigw-id: Ca-v-EJmoAMEpqw</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>
</span>
<span></span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;message&quot;</span><span class="token" style="color:hsl(29, 54%, 61%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;Endpoint request timed out&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">}</span></code></pre></div></pre>
<h3>クライアント側の対応策</h3>
<p>タイムアウトに対してクライアント側で考えられる対応策は以下の通りです。</p>
<ol>
<li>
<p><strong>リトライの実装</strong></p>
<p>タイムアウトが一時的である可能性があるため、504エラー時にリトライを実施する。</p>
</li>
<li>
<p><strong>調査用情報の活用</strong></p>
<ul>
<li><code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">x-amzn-requestid</code> と <code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">x-amz-apigw-id</code> を取得し、ログや通知システムに保存。これらの情報はCloudWatch Logsでの調査に役立つ。</li>
</ul>
</li>
<li>
<p><strong>アラート設定</strong></p>
<p>頻繁にタイムアウトが発生する場合にはアラートを送信し、開発チームに早期対応を促す。</p>
</li>
</ol>
<hr/>
<h2>検証2: Lambda関数から同期で他のLambda関数を実行</h2>
<h3>呼び出し元関数</h3>
<p>以下の呼び出し元関数を1分のタイムアウト設定で実装しました。この関数から、タイムアウトが設定された別のLambda関数を同期的に実行します。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> json
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> boto3
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    lambda_client </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>client</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;lambda&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    function_name </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;TimeOut&#x27;</span><span>
</span><span>    response </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> lambda_client</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>invoke</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>FunctionName</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>function_name</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;=====print response start=====&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>response</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;=====print response end=====&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;body&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> json</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dumps</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Hello from Lambda!&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<h3>実験結果</h3>
<p>呼び出し先のLambda関数がタイムアウトすると、以下のようなレスポンスが返りました。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>  </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ResponseMetadata&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;RequestId&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;36337419-d972-4d5b-b08e-b5f125859dcb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;HTTPStatusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;HTTPHeaders&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>      </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;x-amzn-requestid&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;36337419-d972-4d5b-b08e-b5f125859dcb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>      </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;x-amz-function-error&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Unhandled&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>      </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;x-amzn-trace-id&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Root=1-675449fe-3bb52bbf04bfa28c7dc64c26&#x27;</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>  </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>  </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;FunctionError&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Unhandled&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>  </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Payload&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;errorMessage&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Task timed out after 30.02 seconds&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<h3>呼び出し元の対応策</h3>
<ol>
<li>
<p><strong>エラー情報のチェック</strong></p>
<p><code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">FunctionError</code> の存在や <code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">Payload</code> を解析し、タイムアウトが原因かを判断する。タイムアウトが原因の場合、リトライ処理を検討する。</p>
</li>
<li>
<p><strong>ログの活用</strong></p>
<ul>
<li><code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">x-amzn-requestid</code> をエラー情報として記録。呼び出し先関数のログ調査時に役立つ。</li>
<li><code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">x-amzn-trace-id</code> を記録。X-Rayを活用したトレーシングでシステム全体の動作を追跡可能。</li>
</ul>
</li>
<li>
<p><strong>アラート設定</strong></p>
<p>タイムアウトの頻度が高い場合、アラートを設定し、異常検知の迅速化を図る。</p>
</li>
</ol>
<hr/>
<h1>結論</h1>
<p>AWS Lambdaのタイムアウト問題は、適切にハンドリングすることでシステムの信頼性を高めることができます。本記事で紹介した方法を参考に、以下のポイントを意識した対策を行いましょう。</p>
<ol>
<li>
<p><strong>リトライ戦略の実装</strong></p>
<p>一時的な問題であれば、リトライで解決する場合があります。</p>
</li>
<li>
<p><strong>ログの充実化</strong></p>
<p>調査に役立つリクエストIDやトレースIDをエラーログとして記録。</p>
</li>
<li>
<p><strong>アラートと通知</strong></p>
<p>問題が発生した際には迅速に開発チームが対応できるような仕組みを構築。</p>
</li>
<li>
<p><strong>設計の見直し</strong></p>
<p>タイムアウトの根本原因（処理時間が長すぎるなど）を分析し、コードやシステム構成の改善も検討する。</p>
</li>
</ol>
<p>AWS Lambdaの柔軟性を活かしつつ、堅牢で信頼性の高いシステムを構築していきましょう。</p>
<hr/><div class="text-center mt-8"><a class="inline-block bg-gray-800 text-white no-underline px-4 py-2 rounded hover:bg-gray-700" href="/">← 記事一覧に戻る</a></div><div class="my-12 text-center"><p class="font-bold text-gray-800">合同会社raisexでは一緒に働く仲間を募集中です。</p><p class="text-sm text-gray-600 mb-4">ご興味のある方は以下の採用情報をご確認ください。</p><div class="flex justify-center"><div class="engage-recruit-widget" data-height="300" data-width="500" data-url="https://en-gage.net/raisex_jobs/widget/?banner=1"></div></div></div></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"id":200,"documentId":"lvazy668vfdl9p758u63i57n","title":"同期処理におけるAWS Lambda関数タイムアウトのハンドリング検討","content":"# 背景\n\n弊社ではサーバーレスアーキテクチャを活用した開発を進めており、AWS Lambdaも多くのプロジェクトで利用しています。しかし、Lambda関数のタイムアウトが発生した場合のハンドリングが不十分で、サービスの一時的な停止や、顧客体験の低下に繋がる事例が発生しました。本記事では、Lambda関数のタイムアウトに対する適切なハンドリング方法を検討し、より信頼性の高いシステム構築を目指します。\n\n---\n\n# 検証概要\n\n1. **API Gateway + Lambda構成**\n    - クライアント(frontend)からのリクエスト時にタイムアウトするケースを想定し、ハンドリングを検討\n2. **Lambda関数から同期で他のLambda関数を実行**\n    - バックエンドでの実行時にタイムアウトするケースを想定し、ハンドリングを検討\n\n---\n\n## 検証1: API Gateway + Lambda構成\n\n### 再現するタイムアウトの設定\n\n以下のLambda関数を30秒のタイムアウト設定で実装しました。この関数は、45秒間スリープするため確実にタイムアウトが発生します。\n\n```python\nimport json\nimport time\n\ndef lambda_handler(event, context):\n    print('=====sleep start=====')\n    time.sleep(45)\n    print('=====sleep end=====')\n    return {\n        'statusCode': 200,\n        'body': json.dumps('Hello from Lambda!')\n    }\n\n```\n\n### 実験内容\n\nこの関数をAPI Gatewayで `GET /time-out` エンドポイントとして公開し、以下のコマンドでリクエストを実行しました。\n\n```bash\ncurl https://your.domain/time-out -i\n\n```\n\n### 結果\n\nタイムアウトが発生した場合、以下のレスポンスが返ってきました。\n\n```bash\nHTTP/2 504 \ndate: Sat, 07 Dec 2024 12:51:53 GMT\ncontent-type: application/json\ncontent-length: 41\nx-amzn-requestid: de0b98ff-54cb-46af-acb3-d3d3f08dd189\nx-amzn-errortype: InternalServerErrorException\nx-amz-apigw-id: Ca-v-EJmoAMEpqw=\n\n{\"message\": \"Endpoint request timed out\"}\n```\n\n### クライアント側の対応策\n\nタイムアウトに対してクライアント側で考えられる対応策は以下の通りです。\n\n1. **リトライの実装**\n    \n    タイムアウトが一時的である可能性があるため、504エラー時にリトライを実施する。\n    \n2. **調査用情報の活用**\n    - `x-amzn-requestid` と `x-amz-apigw-id` を取得し、ログや通知システムに保存。これらの情報はCloudWatch Logsでの調査に役立つ。\n3. **アラート設定**\n    \n    頻繁にタイムアウトが発生する場合にはアラートを送信し、開発チームに早期対応を促す。\n    \n\n---\n\n## 検証2: Lambda関数から同期で他のLambda関数を実行\n\n### 呼び出し元関数\n\n以下の呼び出し元関数を1分のタイムアウト設定で実装しました。この関数から、タイムアウトが設定された別のLambda関数を同期的に実行します。\n\n```python\nimport json\nimport boto3\n\ndef lambda_handler(event, context):\n    lambda_client = boto3.client('lambda')\n    function_name = 'TimeOut'\n    response = lambda_client.invoke(FunctionName=function_name)\n\n    print('=====print response start=====')\n    print(response)\n    print('=====print response end=====')\n\n    return {\n        'statusCode': 200,\n        'body': json.dumps('Hello from Lambda!')\n    }\n\n```\n\n### 実験結果\n\n呼び出し先のLambda関数がタイムアウトすると、以下のようなレスポンスが返りました。\n\n```python\n{\n  'ResponseMetadata': {\n    'RequestId': '36337419-d972-4d5b-b08e-b5f125859dcb',\n    'HTTPStatusCode': 200,\n    'HTTPHeaders': {\n      'x-amzn-requestid': '36337419-d972-4d5b-b08e-b5f125859dcb',\n      'x-amz-function-error': 'Unhandled',\n      'x-amzn-trace-id': 'Root=1-675449fe-3bb52bbf04bfa28c7dc64c26'\n    }\n  },\n  'FunctionError': 'Unhandled',\n  'Payload': {'errorMessage': 'Task timed out after 30.02 seconds'}\n}\n\n```\n\n### 呼び出し元の対応策\n\n1. **エラー情報のチェック**\n    \n    `FunctionError` の存在や `Payload` を解析し、タイムアウトが原因かを判断する。タイムアウトが原因の場合、リトライ処理を検討する。\n    \n2. **ログの活用**\n    - `x-amzn-requestid` をエラー情報として記録。呼び出し先関数のログ調査時に役立つ。\n    - `x-amzn-trace-id` を記録。X-Rayを活用したトレーシングでシステム全体の動作を追跡可能。\n3. **アラート設定**\n    \n    タイムアウトの頻度が高い場合、アラートを設定し、異常検知の迅速化を図る。\n    \n\n---\n\n# 結論\n\nAWS Lambdaのタイムアウト問題は、適切にハンドリングすることでシステムの信頼性を高めることができます。本記事で紹介した方法を参考に、以下のポイントを意識した対策を行いましょう。\n\n1. **リトライ戦略の実装**\n    \n    一時的な問題であれば、リトライで解決する場合があります。\n    \n2. **ログの充実化**\n    \n    調査に役立つリクエストIDやトレースIDをエラーログとして記録。\n    \n3. **アラートと通知**\n    \n    問題が発生した際には迅速に開発チームが対応できるような仕組みを構築。\n    \n4. **設計の見直し**\n    \n    タイムアウトの根本原因（処理時間が長すぎるなど）を分析し、コードやシステム構成の改善も検討する。\n    \n\nAWS Lambdaの柔軟性を活かしつつ、堅牢で信頼性の高いシステムを構築していきましょう。\n\n---\n\n","createdAt":"2025-05-19T08:50:57.746Z","updatedAt":"2025-06-01T23:54:20.067Z","publishedAt":"2025-06-01T23:54:20.081Z","docId":"d9jgock9fc3on7jzthp4yxpk","tags":[{"id":10,"documentId":"cxt2tbnsy05cazm17p3pp1a3","createdAt":"2025-05-19T09:46:58.860Z","updatedAt":"2025-05-19T09:46:58.860Z","publishedAt":"2025-05-19T09:46:58.868Z","name":"AWS"},{"id":12,"documentId":"c3lesvkdvjiq7y5zfx9mx0tu","createdAt":"2025-05-19T09:47:14.973Z","updatedAt":"2025-05-19T09:47:14.973Z","publishedAt":"2025-05-19T09:47:14.980Z","name":"Backend"}],"thumbnail":[{"id":16,"documentId":"be0v207b9pqnyvyu5b7xbxlm","name":"20250513-12.png","alternativeText":null,"caption":null,"width":1504,"height":844,"formats":{"thumbnail":{"name":"thumbnail_20250513-12.png","hash":"thumbnail_20250513_12_449ae1295c","ext":".png","mime":"image/png","path":null,"width":245,"height":137,"size":16.74,"sizeInBytes":16736,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/thumbnail_20250513_12_449ae1295c.png"},"small":{"name":"small_20250513-12.png","hash":"small_20250513_12_449ae1295c","ext":".png","mime":"image/png","path":null,"width":500,"height":281,"size":41.74,"sizeInBytes":41736,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/small_20250513_12_449ae1295c.png"},"large":{"name":"large_20250513-12.png","hash":"large_20250513_12_449ae1295c","ext":".png","mime":"image/png","path":null,"width":1000,"height":561,"size":97.46,"sizeInBytes":97462,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/large_20250513_12_449ae1295c.png"},"medium":{"name":"medium_20250513-12.png","hash":"medium_20250513_12_449ae1295c","ext":".png","mime":"image/png","path":null,"width":750,"height":421,"size":68.75,"sizeInBytes":68750,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_12_449ae1295c.png"}},"hash":"20250513_12_449ae1295c","ext":".png","mime":"image/png","size":27.43,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/20250513_12_449ae1295c.png","previewUrl":null,"provider":"@strapi/provider-upload-aws-s3","provider_metadata":null,"createdAt":"2025-05-20T07:45:50.233Z","updatedAt":"2025-05-20T07:45:50.233Z","publishedAt":"2025-05-20T07:45:50.234Z"}]}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"lvazy668vfdl9p758u63i57n"},"buildId":"QTcQf_D8J2NMGF1e92-0w","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>