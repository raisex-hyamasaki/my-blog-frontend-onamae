<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="最新の技術トレンド、プログラミング、ソフトウェア開発、ツールのレビュー、プロジェクト管理等についての考察をお届け"/><meta property="og:url" content="https://blog.raisex.jp/articles/o0cmjsrwp73fm9jd2i3s0d80"/><meta property="og:title" content="DynamoDBからの全データ取得におけるプラクティス | レイズクロスTechBlog"/><meta property="og:description" content="最新の技術トレンド、プログラミング、ソフトウェア開発、ツールのレビュー、プロジェクト管理等についての考察をお届け"/><meta property="og:image" content="https://blog.raisex.jphttps://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_10_4b5734cef6.png"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><title>DynamoDBからの全データ取得におけるプラクティス<!-- --> | レイズクロス Tech Blog</title><meta name="next-head-count" content="11"/><link rel="preload" href="/_next/static/css/7d757bdfdfb985a7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7d757bdfdfb985a7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-2c547fd4592db0a6.js" defer=""></script><script src="/_next/static/chunks/framework-e952fed463eb8e34.js" defer=""></script><script src="/_next/static/chunks/main-72cf801a60c05482.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b6737859a806843a.js" defer=""></script><script src="/_next/static/chunks/a2bf56a3-f921f321ae1e0e8d.js" defer=""></script><script src="/_next/static/chunks/61-43a5fb199f2ef164.js" defer=""></script><script src="/_next/static/chunks/257-c12ad0b16790f4c5.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-1f9ae5c384ab52dd.js" defer=""></script><script src="/_next/static/wdcbjCbp8DYGqTQVAi4UF/_buildManifest.js" defer=""></script><script src="/_next/static/wdcbjCbp8DYGqTQVAi4UF/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-[1024px] mx-auto px-4"><header class="sticky top-0 z-20 bg-white border-b border-gray-200 h-12 flex items-center justify-between px-4"><a class="text-blue-600 no-underline hover:text-gray-600 text-lg font-bold" href="/">📋 レイズクロス Tech Blog</a><div class="flex gap-3"><a href="https://twitter.com/share" target="_blank" rel="noopener noreferrer"><img src="/icons/x.svg" alt="Share on X" class="h-7 w-7"/></a><a href="https://www.facebook.com/sharer/sharer.php" target="_blank" rel="noopener noreferrer"><img src="/icons/facebook.svg" alt="Share on Facebook" class="h-7 w-7"/></a><a href="https://social-plugins.line.me/lineit/share" target="_blank" rel="noopener noreferrer"><img src="/icons/line.svg" alt="Share on LINE" class="h-7 w-7"/></a></div></header><article class="prose prose-slate max-w-none pt-6"><h1 class="text-3xl font-bold border-b pb-2">DynamoDBからの全データ取得におけるプラクティス</h1><div class="text-sm text-gray-500 mb-4">投稿更新日: <!-- -->2025/6/6 8:54:33</div><div class="flex flex-wrap gap-2 mb-4"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">#<!-- -->AWS</span><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">#<!-- -->Backend</span></div><div class="w-full flex justify-center mb-6"><img src="https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_10_4b5734cef6.png" alt="サムネイル" class="w-full max-w-[800px] h-auto rounded"/></div><p>弊社は、サーバーレスアーキテクチャの開発を得意としており、Amazon DynamoDBやAWS Lambda等のサービスを活用した効率的でスケーラブルなシステム設計を提供しています。</p>
<p>その中で、アプリケーション開発において「画面に全データを一覧表示する」という仕様はよく見られるものの、NoSQLデータベースでは適切なアプローチを選ばないとパフォーマンスやコストの課題が発生します。</p>
<p>本記事では、DynamoDBから全データを取得する方法と、その実験結果をもとにした設計上の注意点について解説します。</p>
<hr/>
<h1><strong>全データ取得の課題</strong></h1>
<p>DynamoDBはスケーラビリティに優れたデータベースですが、設計次第で処理性能が大きく変化します。</p>
<p>特に以下の点に注意が必要です:</p>
<ul>
<li><strong>Scanのリスク</strong>:
Scanはテーブル全体をフルスキャンするため、膨大なデータ量の場合に時間がかかり、コストも増加します。</li>
<li><strong>Queryの可能性</strong>:
適切に設計されたパーティションキーとソートキーを利用することで、特定のデータセットを効率的に取得できます。</li>
</ul>
<hr/>
<h1><strong>実験概要</strong></h1>
<p>DynamoDBで3万件、10万件のデータを用意し、ScanとQueryの処理時間を比較しました。以下の2つのアプローチを検証しています。</p>
<ol>
<li><strong>全データを単一パーティションにまとめる</strong></li>
<li><strong>データを複数パーティションに分散させる</strong></li>
</ol>
<p>データはAWS公式サンプルリポジトリ <a href="https://github.com/aws-samples/csv-to-dynamodb" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">aws-samples/csv-to-dynamodb</a> のtestfile.csvを使用。</p>
<p>実験のパターンごとに少しデータを修正し、投入します。</p>
<hr/>
<h2><strong>実験1: 単一パーティションにまとめる</strong></h2>
<h3><strong>手法</strong></h3>
<ul>
<li><strong>パーティションキー</strong>: 固定値（例: <code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">DATA</code>）を設定するGSIを作成。</li>
<li><strong>目的</strong>: 単一パーティションにデータを格納し、Queryで効率的に全データを取得する。</li>
</ul>
<p><strong>データ構造例:</strong></p>























<table class="border border-gray-400 w-full text-sm my-4 whitespace-pre-wrap table-fixed"><thead class="bg-cyan-100 text-black"><tr><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">DataType (PK)</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">uuid</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">Country</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">ItemType</th></tr></thead><tbody><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">DATA</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">535113847</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Azerbaijan</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Snacks</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">DATA</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">874708545</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Panama</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Cosmetics</td></tr></tbody></table>
<p>Queryのソースコード(AWS Lambda用)</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> boto3
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">from</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dynamodb</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>conditions </span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> Key
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    table_name </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;test_datas&#x27;</span><span>
</span><span>    region </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;us-east-1&#x27;</span><span>
</span><span>    gsi_name </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;DataType-index&#x27;</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># DynamoDBクライアントの初期化</span><span>
</span><span>    dynamodb </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>resource</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;dynamodb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> region_name</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>region</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    table </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> dynamodb</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Table</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>table_name</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># クエリ条件 DataType が DATA</span><span>
</span><span>    key_condition_expression </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> Key</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;DataType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>eq</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;DATA&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">try</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        options </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;IndexName&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> gsi_name</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;KeyConditionExpression&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> key_condition_expression</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ReturnConsumedCapacity&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;TOTAL&#x27;</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">while</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>            response </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> table</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>query</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(207, 82%, 66%)">**</span><span>options</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            next_token </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> response</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>get</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;LastEvaluatedKey&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">None</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>next_token</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">if</span><span> next_token</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                options</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ExclusiveStartKey&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> next_token
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">else</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                </span><span class="token" style="color:hsl(286, 60%, 67%)">break</span><span>
</span>
<span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">except</span><span> Exception </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> e</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;エラー:&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> e</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">500</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;body&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;サーバーエラーが発生しました&#x27;</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<p>Scanのソースコード(AWS Lambda用)</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> boto3
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    table_name </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;test_datas_&#x27;</span><span>
</span><span>    region </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;us-east-1&#x27;</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># DynamoDBクライアントの初期化</span><span>
</span><span>    dynamodb </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>resource</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;dynamodb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> region_name</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>region</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    table </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> dynamodb</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Table</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>table_name</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">try</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        options </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ReturnConsumedCapacity&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;TOTAL&#x27;</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">while</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>            response </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> table</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>scan</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(207, 82%, 66%)">**</span><span>options</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            next_token </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> response</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>get</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;LastEvaluatedKey&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">None</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>next_token</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">if</span><span> next_token</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                options</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ExclusiveStartKey&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> next_token
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">else</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                </span><span class="token" style="color:hsl(286, 60%, 67%)">break</span><span>
</span>
<span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">except</span><span> Exception </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> e</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;エラー:&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> e</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">500</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;body&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;サーバーエラーが発生しました&#x27;</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<h3><strong>結果(Lambdaのウォームスタート)</strong></h3>



































<table class="border border-gray-400 w-full text-sm my-4 whitespace-pre-wrap table-fixed"><thead class="bg-cyan-100 text-black"><tr><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">データ量</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">メモリ (MB)</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">Query (秒)</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">Scan (秒)</th></tr></thead><tbody><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">3万件</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">512</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">15</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">15</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap"></td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">2048</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">4</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">5</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">10万件</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">512</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">50</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">50</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap"></td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">2048</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">13</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">15</td></tr></tbody></table>
<h3><strong>考察</strong></h3>
<ul>
<li>全データ取得という観点ではScanもQueryもあまり処理時間の違いはないことがわかります。</li>
<li>データ量が増えると取得時間が数十秒かかるため、ユーザー体験の悪化が懸念されます。</li>
<li>メモリを増やすことで処理時間が短縮されますが、それでも数万件以上では非同期処理や別の工夫が必要です。</li>
</ul>
<hr/>
<h2><strong>実験2: データを複数パーティションに分散する</strong></h2>
<h3><strong>手法</strong></h3>
<ul>
<li><strong>パーティションキー</strong>: シャード番号やランダム識別子を付加。</li>
<li><strong>目的</strong>: データを複数のパーティションに分散し、並列処理で取得速度を向上させる。</li>
</ul>
<p><strong>データ構造例:</strong></p>


























<table class="border border-gray-400 w-full text-sm my-4 whitespace-pre-wrap table-fixed"><thead class="bg-cyan-100 text-black"><tr><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">ItemCategory (PK)</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">uuid</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">DataType</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">Country</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">ItemType</th></tr></thead><tbody><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">ItemCategory#11</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">535113847</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">DATA</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Azerbaijan</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Snacks</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">ItemCategory#5</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">874708545</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">DATA</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Panama</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Cosmetics</td></tr></tbody></table>
<p>並列でクエリを実行するソースコード(AWS Lambda用)</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> boto3
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> os
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">from</span><span> botocore</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>config </span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> Config
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">from</span><span> concurrent</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>futures </span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> ThreadPoolExecutor</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> as_completed
</span>
<span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># DynamoDB テーブル名</span><span>
</span><span>TABLE_NAME </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;test_datas&quot;</span><span>
</span><span>SHARD_COUNT </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">12</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># シャードの数</span><span>
</span>
<span>custom_config </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> Config</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>
</span><span>    max_pool_connections</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">12</span><span>
</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># DynamoDB クライアントの作成</span><span>
</span><span>dynamodb </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>client</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;dynamodb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> config</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>custom_config</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 最大ワーカー数</span><span>
</span><span>max_workers </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">min</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">32</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> os</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>cpu_count</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">5</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">query_shard</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>partition_key</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;指定されたシャードをクエリする関数&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">try</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        items </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span>        options </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;TableName&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> TABLE_NAME</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;IndexName&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ItemCategory-index&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;KeyConditionExpression&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;ItemCategory = :pk&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ExpressionAttributeValues&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;:pk&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;S&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> partition_key</span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">while</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>            response </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> dynamodb</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>query</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(207, 82%, 66%)">**</span><span>options</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            items</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>extend</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>response</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>get</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;Items&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            next_token </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> response</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>get</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;LastEvaluatedKey&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">None</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">if</span><span> next_token</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                options</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;ExclusiveStartKey&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> next_token
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">else</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                </span><span class="token" style="color:hsl(286, 60%, 67%)">break</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">partition_key</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation" style="color:hsl(95, 38%, 62%)">len</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation interpolation">items</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">)</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">件&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> items
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">except</span><span> Exception </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> e</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;Error querying </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">partition_key</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">query_all_shards</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;すべてのシャードを並列でクエリする&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&#x27;max_workers: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">max_workers</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">with</span><span> ThreadPoolExecutor</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>max_workers</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>max_workers</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> executor</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># シャードごとにクエリを実行</span><span>
</span><span>        futures </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            executor</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>submit</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>query_shard</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;ItemCategory#</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">shard_number</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> shard_number
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> shard_number </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">range</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> SHARD_COUNT </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span>        
<span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 結果を集約</span><span>
</span><span>        results </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> future </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> as_completed</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>futures</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">try</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                shard_result </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> future</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>result</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>                results</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>extend</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>shard_result</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>            </span><span class="token" style="color:hsl(286, 60%, 67%)">except</span><span> Exception </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> e</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>                </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;Error in shard </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">futures</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">[</span><span class="token string-interpolation interpolation">future</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">]</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>        
<span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> results
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;Lambda 関数のエントリポイント&quot;&quot;&quot;</span><span>
</span><span>    results </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> query_all_shards</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&#x27;</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation" style="color:hsl(95, 38%, 62%)">len</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation interpolation">results</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">)</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">件&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;statusCode&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;body&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span></code></pre></div></pre>
<h3><strong>結果(Lambdaのウォームスタート)</strong></h3>






























<table class="border border-gray-400 w-full text-sm my-4 whitespace-pre-wrap table-fixed"><thead class="bg-cyan-100 text-black"><tr><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">データ量</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">メモリ (MB)</th><th class="w-1/4 border border-gray-400 px-2 py-1 text-left font-medium whitespace-pre-wrap">Query (秒)</th></tr></thead><tbody><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">3万件</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">512</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">11</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap"></td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">2048</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">3.3</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">10万件</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">512</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">Out of memory Error</td></tr><tr><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap"></td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">2048</td><td class="w-1/4 border border-gray-300 px-2 py-1 whitespace-pre-wrap">10</td></tr></tbody></table>
<h3><strong>考察</strong></h3>
<ul>
<li>パーティション分散により取得速度が向上しました。</li>
<li>データ量が増えるとOut of Memoryエラーが発生する可能性があるため、クエリ方法やメモリ管理の工夫が必要です。</li>
</ul>
<hr/>
<h1><strong>まとめ</strong></h1>
<p>DynamoDBで全データを取得する際のベストプラクティスは以下の通りです。</p>
<ol>
<li><strong>データ量が少ない場合</strong>: 単一パーティションでQueryを使用しても問題ありません。</li>
<li><strong>データ量が多い場合</strong>: パーティションを分散し、並列でQueryを実行することで効率的にデータを取得可能です。</li>
<li><strong>非同期処理</strong>: データ量が多い場合は同期処理ではなく、非同期でデータを取得する設計を検討しましょう。</li>
<li><strong>仕様の再検討</strong>: 全データを一覧表示する代わりに、条件を絞り込んで表示する仕様に変更できないかをまず検討するべきでしょう。</li>
</ol>
<p>効率的なデータ取得には、データ設計とアプリケーション設計のバランスが欠かせません。本記事を参考に、DynamoDBを活用したパフォーマンスの高いアプリケーションを構築してください！</p>
<hr/><div class="text-center mt-8"><a class="inline-block bg-gray-800 text-white no-underline px-4 py-2 rounded hover:bg-gray-700" href="/">← 記事一覧に戻る</a></div><div class="my-12 text-center"><p class="font-bold text-gray-800">合同会社raisexでは一緒に働く仲間を募集中です。</p><p class="text-sm text-gray-600 mb-4">ご興味のある方は以下の採用情報をご確認ください。</p><div class="flex justify-center"><div class="engage-recruit-widget" data-height="300" data-width="500" data-url="https://en-gage.net/raisex_jobs/widget/?banner=1"></div></div></div></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"id":258,"documentId":"o0cmjsrwp73fm9jd2i3s0d80","title":"DynamoDBからの全データ取得におけるプラクティス","content":"弊社は、サーバーレスアーキテクチャの開発を得意としており、Amazon DynamoDBやAWS Lambda等のサービスを活用した効率的でスケーラブルなシステム設計を提供しています。\n\nその中で、アプリケーション開発において「画面に全データを一覧表示する」という仕様はよく見られるものの、NoSQLデータベースでは適切なアプローチを選ばないとパフォーマンスやコストの課題が発生します。\n\n本記事では、DynamoDBから全データを取得する方法と、その実験結果をもとにした設計上の注意点について解説します。\n\n---\n\n# **全データ取得の課題**\n\nDynamoDBはスケーラビリティに優れたデータベースですが、設計次第で処理性能が大きく変化します。\n\n特に以下の点に注意が必要です:\n\n- **Scanのリスク**:\nScanはテーブル全体をフルスキャンするため、膨大なデータ量の場合に時間がかかり、コストも増加します。\n- **Queryの可能性**:\n適切に設計されたパーティションキーとソートキーを利用することで、特定のデータセットを効率的に取得できます。\n\n---\n\n# **実験概要**\n\nDynamoDBで3万件、10万件のデータを用意し、ScanとQueryの処理時間を比較しました。以下の2つのアプローチを検証しています。\n\n1. **全データを単一パーティションにまとめる**\n2. **データを複数パーティションに分散させる**\n\nデータはAWS公式サンプルリポジトリ [aws-samples/csv-to-dynamodb](https://github.com/aws-samples/csv-to-dynamodb) のtestfile.csvを使用。\n\n実験のパターンごとに少しデータを修正し、投入します。\n\n---\n\n## **実験1: 単一パーティションにまとめる**\n\n### **手法**\n\n- **パーティションキー**: 固定値（例: `DATA`）を設定するGSIを作成。\n- **目的**: 単一パーティションにデータを格納し、Queryで効率的に全データを取得する。\n\n**データ構造例:**\n\n| DataType (PK) | uuid | Country | ItemType |\n| --- | --- | --- | --- |\n| DATA | 535113847 | Azerbaijan | Snacks |\n| DATA | 874708545 | Panama | Cosmetics |\n\nQueryのソースコード(AWS Lambda用)\n\n```python\nimport boto3\nfrom boto3.dynamodb.conditions import Key\n\ndef lambda_handler(event, context):\n    table_name = 'test_datas'\n    region = 'us-east-1'\n    gsi_name = 'DataType-index'\n\n    # DynamoDBクライアントの初期化\n    dynamodb = boto3.resource('dynamodb', region_name=region)\n    table = dynamodb.Table(table_name)\n\n    # クエリ条件 DataType が DATA\n    key_condition_expression = Key('DataType').eq('DATA')\n\n    try:\n        options = {\n            'IndexName': gsi_name,\n            'KeyConditionExpression': key_condition_expression,\n            'ReturnConsumedCapacity': 'TOTAL'\n        }\n        while True:\n            response = table.query(**options)\n            next_token = response.get('LastEvaluatedKey', None)\n            print(next_token)\n\n            if next_token:\n                options['ExclusiveStartKey'] = next_token\n            else:\n                break\n\n        return {\n            'statusCode': 200\n        }\n    except Exception as e:\n        print('エラー:', e)\n        return {\n            'statusCode': 500,\n            'body': 'サーバーエラーが発生しました'\n        }\n\n```\n\nScanのソースコード(AWS Lambda用)\n\n```python\nimport boto3\n\ndef lambda_handler(event, context):\n    table_name = 'test_datas_'\n    region = 'us-east-1'\n\n    # DynamoDBクライアントの初期化\n    dynamodb = boto3.resource('dynamodb', region_name=region)\n    table = dynamodb.Table(table_name)\n\n    try:\n        options = {\n            'ReturnConsumedCapacity': 'TOTAL'\n        }\n        while True:\n            response = table.scan(**options)\n            next_token = response.get('LastEvaluatedKey', None)\n            print(next_token)\n\n            if next_token:\n                options['ExclusiveStartKey'] = next_token\n            else:\n                break\n\n        return {\n            'statusCode': 200\n        }\n    except Exception as e:\n        print('エラー:', e)\n        return {\n            'statusCode': 500,\n            'body': 'サーバーエラーが発生しました'\n        }\n\n```\n\n### **結果(Lambdaのウォームスタート)**\n\n| データ量 | メモリ (MB) | Query (秒) | Scan (秒) |\n| --- | --- | --- | --- |\n| 3万件 | 512 | 15 | 15 |\n|  | 2048 | 4 | 5 |\n| 10万件 | 512 | 50 | 50 |\n|  | 2048 | 13 | 15 |\n\n### **考察**\n\n- 全データ取得という観点ではScanもQueryもあまり処理時間の違いはないことがわかります。\n- データ量が増えると取得時間が数十秒かかるため、ユーザー体験の悪化が懸念されます。\n- メモリを増やすことで処理時間が短縮されますが、それでも数万件以上では非同期処理や別の工夫が必要です。\n\n---\n\n## **実験2: データを複数パーティションに分散する**\n\n### **手法**\n\n- **パーティションキー**: シャード番号やランダム識別子を付加。\n- **目的**: データを複数のパーティションに分散し、並列処理で取得速度を向上させる。\n\n**データ構造例:**\n\n| ItemCategory (PK) | uuid | DataType | Country | ItemType |\n| --- | --- | --- | --- | --- |\n| ItemCategory#11 | 535113847 | DATA | Azerbaijan | Snacks |\n| ItemCategory#5 | 874708545 | DATA | Panama | Cosmetics |\n\n並列でクエリを実行するソースコード(AWS Lambda用)\n\n```python\nimport boto3\nimport os\nfrom botocore.config import Config\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\n\n# DynamoDB テーブル名\nTABLE_NAME = \"test_datas\"\nSHARD_COUNT = 12  # シャードの数\n\ncustom_config = Config(\n    max_pool_connections=12\n)\n# DynamoDB クライアントの作成\ndynamodb = boto3.client('dynamodb', config=custom_config)\n\n# 最大ワーカー数\nmax_workers = min(32, os.cpu_count() * 5)\n\ndef query_shard(partition_key):\n    \"\"\"指定されたシャードをクエリする関数\"\"\"\n    try:\n        items = []\n        options = {\n            'TableName': TABLE_NAME,\n            'IndexName': 'ItemCategory-index',\n            'KeyConditionExpression': \"ItemCategory = :pk\",\n            'ExpressionAttributeValues': {\":pk\": {\"S\": partition_key}}\n        }\n        while True:\n            response = dynamodb.query(**options)\n            items.extend(response.get(\"Items\", []))\n            next_token = response.get('LastEvaluatedKey', None)\n            if next_token:\n                options['ExclusiveStartKey'] = next_token\n            else:\n                break\n        print(f\"{partition_key}: {len(items)}件\")\n        return items\n    except Exception as e:\n        print(f\"Error querying {partition_key}: {e}\")\n        return []\n\ndef query_all_shards():\n    \"\"\"すべてのシャードを並列でクエリする\"\"\"\n    print(f'max_workers: {max_workers}')\n    with ThreadPoolExecutor(max_workers=max_workers) as executor:\n        # シャードごとにクエリを実行\n        futures = {\n            executor.submit(query_shard, f\"ItemCategory#{shard_number}\"): shard_number\n            for shard_number in range(1, SHARD_COUNT + 1)\n        }\n        \n        # 結果を集約\n        results = []\n        for future in as_completed(futures):\n            try:\n                shard_result = future.result()\n                results.extend(shard_result)\n            except Exception as e:\n                print(f\"Error in shard {futures[future]}: {e}\")\n        \n        return results\n\ndef lambda_handler(event, context):\n    \"\"\"Lambda 関数のエントリポイント\"\"\"\n    results = query_all_shards()\n    print(f'{len(results)}件')\n    return {\n        \"statusCode\": 200,\n        \"body\": {\n        }\n    }\n```\n\n### **結果(Lambdaのウォームスタート)**\n\n| データ量 | メモリ (MB) | Query (秒) |\n| --- | --- | --- |\n| 3万件 | 512 | 11 |\n|  | 2048 | 3.3 |\n| 10万件 | 512 | Out of memory Error |\n|  | 2048 | 10 |\n\n### **考察**\n\n- パーティション分散により取得速度が向上しました。\n- データ量が増えるとOut of Memoryエラーが発生する可能性があるため、クエリ方法やメモリ管理の工夫が必要です。\n\n---\n\n# **まとめ**\n\nDynamoDBで全データを取得する際のベストプラクティスは以下の通りです。\n\n1. **データ量が少ない場合**: 単一パーティションでQueryを使用しても問題ありません。\n2. **データ量が多い場合**: パーティションを分散し、並列でQueryを実行することで効率的にデータを取得可能です。\n3. **非同期処理**: データ量が多い場合は同期処理ではなく、非同期でデータを取得する設計を検討しましょう。\n4. **仕様の再検討**: 全データを一覧表示する代わりに、条件を絞り込んで表示する仕様に変更できないかをまず検討するべきでしょう。\n\n効率的なデータ取得には、データ設計とアプリケーション設計のバランスが欠かせません。本記事を参考に、DynamoDBを活用したパフォーマンスの高いアプリケーションを構築してください！\n\n---\n\n","createdAt":"2025-05-19T08:50:57.627Z","updatedAt":"2025-06-05T23:54:33.227Z","publishedAt":"2025-06-05T23:54:33.240Z","docId":"hmwidddh8kfenx2ifd67lygc","tags":[{"id":10,"documentId":"cxt2tbnsy05cazm17p3pp1a3","createdAt":"2025-05-19T09:46:58.860Z","updatedAt":"2025-05-19T09:46:58.860Z","publishedAt":"2025-05-19T09:46:58.868Z","name":"AWS"},{"id":12,"documentId":"c3lesvkdvjiq7y5zfx9mx0tu","createdAt":"2025-05-19T09:47:14.973Z","updatedAt":"2025-05-19T09:47:14.973Z","publishedAt":"2025-05-19T09:47:14.980Z","name":"Backend"}],"thumbnail":[{"id":14,"documentId":"hu10hoivv38q6d2d58e0uyhu","name":"20250513-10.png","alternativeText":null,"caption":null,"width":1504,"height":844,"formats":{"thumbnail":{"name":"thumbnail_20250513-10.png","hash":"thumbnail_20250513_10_4b5734cef6","ext":".png","mime":"image/png","path":null,"width":245,"height":137,"size":13.91,"sizeInBytes":13908,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/thumbnail_20250513_10_4b5734cef6.png"},"medium":{"name":"medium_20250513-10.png","hash":"medium_20250513_10_4b5734cef6","ext":".png","mime":"image/png","path":null,"width":750,"height":421,"size":54.78,"sizeInBytes":54781,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_10_4b5734cef6.png"},"small":{"name":"small_20250513-10.png","hash":"small_20250513_10_4b5734cef6","ext":".png","mime":"image/png","path":null,"width":500,"height":281,"size":33.51,"sizeInBytes":33508,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/small_20250513_10_4b5734cef6.png"},"large":{"name":"large_20250513-10.png","hash":"large_20250513_10_4b5734cef6","ext":".png","mime":"image/png","path":null,"width":1000,"height":561,"size":78.42,"sizeInBytes":78418,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/large_20250513_10_4b5734cef6.png"}},"hash":"20250513_10_4b5734cef6","ext":".png","mime":"image/png","size":22.83,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/20250513_10_4b5734cef6.png","previewUrl":null,"provider":"@strapi/provider-upload-aws-s3","provider_metadata":null,"createdAt":"2025-05-20T07:44:41.591Z","updatedAt":"2025-05-20T07:44:41.591Z","publishedAt":"2025-05-20T07:44:41.594Z"}]}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"o0cmjsrwp73fm9jd2i3s0d80"},"buildId":"wdcbjCbp8DYGqTQVAi4UF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>