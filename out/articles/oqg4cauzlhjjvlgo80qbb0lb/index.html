<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="最新の技術トレンド、プログラミング、ソフトウェア開発、ツールのレビュー、プロジェクト管理等についての考察をお届け"/><meta property="og:url" content="https://blog.raisex.jp/articles/oqg4cauzlhjjvlgo80qbb0lb"/><meta property="og:title" content="SNSサブスクリプションフィルターの活用 | レイズクロスTechBlog"/><meta property="og:description" content="最新の技術トレンド、プログラミング、ソフトウェア開発、ツールのレビュー、プロジェクト管理等についての考察をお届け"/><meta property="og:image" content="https://blog.raisex.jphttps://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_05_6c940be6e0.png"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><title>SNSサブスクリプションフィルターの活用<!-- --> | レイズクロス Tech Blog</title><meta name="next-head-count" content="11"/><link rel="preload" href="/_next/static/css/7d757bdfdfb985a7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7d757bdfdfb985a7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-2c547fd4592db0a6.js" defer=""></script><script src="/_next/static/chunks/framework-e952fed463eb8e34.js" defer=""></script><script src="/_next/static/chunks/main-72cf801a60c05482.js" defer=""></script><script src="/_next/static/chunks/pages/_app-b6737859a806843a.js" defer=""></script><script src="/_next/static/chunks/a2bf56a3-f921f321ae1e0e8d.js" defer=""></script><script src="/_next/static/chunks/61-43a5fb199f2ef164.js" defer=""></script><script src="/_next/static/chunks/257-c12ad0b16790f4c5.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bid%5D-1f9ae5c384ab52dd.js" defer=""></script><script src="/_next/static/wdcbjCbp8DYGqTQVAi4UF/_buildManifest.js" defer=""></script><script src="/_next/static/wdcbjCbp8DYGqTQVAi4UF/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-[1024px] mx-auto px-4"><header class="sticky top-0 z-20 bg-white border-b border-gray-200 h-12 flex items-center justify-between px-4"><a class="text-blue-600 no-underline hover:text-gray-600 text-lg font-bold" href="/">📋 レイズクロス Tech Blog</a><div class="flex gap-3"><a href="https://twitter.com/share" target="_blank" rel="noopener noreferrer"><img src="/icons/x.svg" alt="Share on X" class="h-7 w-7"/></a><a href="https://www.facebook.com/sharer/sharer.php" target="_blank" rel="noopener noreferrer"><img src="/icons/facebook.svg" alt="Share on Facebook" class="h-7 w-7"/></a><a href="https://social-plugins.line.me/lineit/share" target="_blank" rel="noopener noreferrer"><img src="/icons/line.svg" alt="Share on LINE" class="h-7 w-7"/></a></div></header><article class="prose prose-slate max-w-none pt-6"><h1 class="text-3xl font-bold border-b pb-2">SNSサブスクリプションフィルターの活用</h1><div class="text-sm text-gray-500 mb-4">投稿更新日: <!-- -->2025/6/6 8:51:32</div><div class="flex flex-wrap gap-2 mb-4"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">#<!-- -->AWS</span></div><div class="w-full flex justify-center mb-6"><img src="https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_05_6c940be6e0.png" alt="サムネイル" class="w-full max-w-[800px] h-auto rounded"/></div><p>AWS SNS（Simple Notification Service）は、アプリケーション間でメッセージをやり取りするための強力なサービスです。SNSの特徴の一つに、特定の条件に基づいてメッセージをフィルタリングするサブスクリプションフィルタがあります。これにより、受信側でメッセージを効率的に振り分ける事が可能です。</p>
<p>この記事では、SNSサブスクリプションフィルターを使ったシステム構成と、そのフィルタリング方法について解説します。</p>
<hr/>
<h1>1. 構成</h1>
<p>SNSサブスクリプションフィルターを活用したシンプルな構成の例です。</p>
<ul>
<li>SNS → SQS → Lambda</li>
</ul>
<p>ここでのポイントは、SNSが複数のSQSにメッセージを配信し、それぞれ異なるLambda関数がそのメッセージを処理するということです。SQSのキューにメッセージを送る際、SNSのサブスクリプションフィルターを使うことで、特定の属性や条件に基づいたメッセージの配信をコントロールできます。</p>
<hr/>
<h1>2. メッセージ属性でのフィルタリング</h1>
<p>SNSのメッセージ属性を利用して、特定の属性値を持つメッセージだけを特定のSQSに配送するように設定できます。</p>
<h3>サブスクリプションフィルターポリシー例</h3>
<p>次のポリシーでは、<code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">filterType</code>という属性が「1」の場合にのみメッセージを受信します。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-json" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>  </span><span class="token" style="color:hsl(355, 65%, 65%)">&quot;filterType&quot;</span><span class="token" style="color:hsl(207, 82%, 66%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;1&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<h3>Lambda関数の例</h3>
<p>Lambda関数からSNSにメッセージを送信する際に、フィルタリング対象となる属性を指定します。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> json
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> boto3
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    sns </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>client</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;sns&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    message </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;type&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;message&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Hello from Lambda!&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;key1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;val1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;key2&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;val2&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;result&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;alertType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;warn&#x27;</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    message_attributes </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;filterType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;DataType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;String&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;StringValue&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span>
<span>    response </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> sns</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>publish</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>
</span><span>        TopicArn</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;arn:aws:sns:us-east-1:9999999999:MyTopic&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># SNSトピックのARNを指定</span><span>
</span><span>        Message</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>json</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dumps</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>message</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># メッセージ本文</span><span>
</span><span>        Subject</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Test message from Lambda&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># メッセージのタイトル（オプション）</span><span>
</span><span>        MessageAttributes</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>message_attributes
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;body&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> json</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dumps</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Hello from Lambda!&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<p>この例では、<code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">filterType</code>が「1」であるメッセージがSNSに送信され、そのメッセージ属性に基づいてフィルタリングが行われます。</p>
<hr/>
<h1>3. メッセージ本文でのフィルタリング</h1>
<p>SNSではメッセージ本文の内容に基づいてもフィルタリングが可能です。次の例では、メッセージ本文内の<code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">result.alertType</code>が「warn」または「error」の場合にのみメッセージを受信します。</p>
<h3>サブスクリプションフィルターポリシー例</h3>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-json" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>  </span><span class="token" style="color:hsl(355, 65%, 65%)">&quot;result&quot;</span><span class="token" style="color:hsl(207, 82%, 66%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>    </span><span class="token" style="color:hsl(355, 65%, 65%)">&quot;alertType&quot;</span><span class="token" style="color:hsl(207, 82%, 66%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>
</span><span>      </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;error&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>      </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;warn&quot;</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span>  </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<h3>Lambda関数の例</h3>
<p>Lambda関数からメッセージを送信する際に、メッセージ本文の内容に基づいたフィルタリングが行われます。</p>
<pre><div class="relative my-4"><button class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button><pre style="background:transparent;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:break-word;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:0.75rem;margin:0;overflow:auto;border-radius:0.5rem;overflow-x:auto"><code class="language-python" style="white-space:pre;background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> json
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> boto3
</span>
<span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">lambda_handler</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>event</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> context</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span>    sns </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> boto3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>client</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;sns&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    message </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;type&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;message&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Hello from Lambda!&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;key1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;val1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;key2&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;val2&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;result&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>            </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;alertType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;warn&#x27;</span><span>
</span><span>        </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    message_attributes </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;filterType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;DataType&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;String&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;StringValue&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;1&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span>
<span>    response </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> sns</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>publish</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>
</span><span>        TopicArn</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;arn:aws:sns:us-east-1:9999999999:MyTopic&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># SNSトピックのARNを指定</span><span>
</span><span>        Message</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>json</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dumps</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>message</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># メッセージ本文</span><span>
</span><span>        Subject</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Test message from Lambda&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># メッセージのタイトル（オプション）</span><span>
</span><span>        MessageAttributes</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span>message_attributes
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;PublishToSns end&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;statusCode&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">200</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span>        </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;body&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> json</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dumps</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;Hello from Lambda!&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span></code></pre></div></pre>
<p>この例では、<code class="bg-yellow-200 font-mono px-[0.3rem] py-[0.1rem] rounded whitespace-nowrap text-inherit">alertType</code>が「warn」であるため、このメッセージはサブスクリプションポリシーで定義されたフィルターを通過します。</p>
<hr/>
<h1>4. まとめ</h1>
<p>SNSサブスクリプションフィルターは、特定のメッセージ属性や本文の内容に基づいて、メッセージをフィルタリングする強力なツールです。この機能を利用することで、例えば特定の警告やエラーが発生した際にのみアラートを発生させるなど、効率的な通知システムを構築できます。</p>
<p>この仕組みを活用することで、無駄なメッセージの受信を減らし、システムのパフォーマンスや管理の効率を向上させることが可能です。AWSのサーバーレスアーキテクチャの一環として、ぜひSNSサブスクリプションフィルターを使いこなしてみてください！！</p>
<hr/><div class="text-center mt-8"><a class="inline-block bg-gray-800 text-white no-underline px-4 py-2 rounded hover:bg-gray-700" href="/">← 記事一覧に戻る</a></div><div class="my-12 text-center"><p class="font-bold text-gray-800">合同会社raisexでは一緒に働く仲間を募集中です。</p><p class="text-sm text-gray-600 mb-4">ご興味のある方は以下の採用情報をご確認ください。</p><div class="flex justify-center"><div class="engage-recruit-widget" data-height="300" data-width="500" data-url="https://en-gage.net/raisex_jobs/widget/?banner=1"></div></div></div></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"id":253,"documentId":"oqg4cauzlhjjvlgo80qbb0lb","title":"SNSサブスクリプションフィルターの活用","content":"AWS SNS（Simple Notification Service）は、アプリケーション間でメッセージをやり取りするための強力なサービスです。SNSの特徴の一つに、特定の条件に基づいてメッセージをフィルタリングするサブスクリプションフィルタがあります。これにより、受信側でメッセージを効率的に振り分ける事が可能です。\n\nこの記事では、SNSサブスクリプションフィルターを使ったシステム構成と、そのフィルタリング方法について解説します。\n\n---\n\n# 1. 構成\n\nSNSサブスクリプションフィルターを活用したシンプルな構成の例です。\n\n- SNS → SQS → Lambda\n\nここでのポイントは、SNSが複数のSQSにメッセージを配信し、それぞれ異なるLambda関数がそのメッセージを処理するということです。SQSのキューにメッセージを送る際、SNSのサブスクリプションフィルターを使うことで、特定の属性や条件に基づいたメッセージの配信をコントロールできます。\n\n---\n\n# 2. メッセージ属性でのフィルタリング\n\nSNSのメッセージ属性を利用して、特定の属性値を持つメッセージだけを特定のSQSに配送するように設定できます。\n\n### サブスクリプションフィルターポリシー例\n\n次のポリシーでは、`filterType`という属性が「1」の場合にのみメッセージを受信します。\n\n```json\n{\n  \"filterType\": [\"1\"]\n}\n\n```\n\n### Lambda関数の例\n\nLambda関数からSNSにメッセージを送信する際に、フィルタリング対象となる属性を指定します。\n\n```python\nimport json\nimport boto3\n\ndef lambda_handler(event, context):\n    sns = boto3.client('sns')\n    message = {\n        'type': '1',\n        'message': 'Hello from Lambda!',\n        'key1': 'val1',\n        'key2': 'val2',\n        'result': {\n            'alertType': 'warn'\n        }\n    }\n    message_attributes = {\n        'filterType': {'DataType': 'String', 'StringValue': '1'}\n    }\n\n    response = sns.publish(\n        TopicArn='arn:aws:sns:us-east-1:9999999999:MyTopic',  # SNSトピックのARNを指定\n        Message=json.dumps(message),  # メッセージ本文\n        Subject='Test message from Lambda',  # メッセージのタイトル（オプション）\n        MessageAttributes=message_attributes\n    )\n\n    return {\n        'statusCode': 200,\n        'body': json.dumps('Hello from Lambda!')\n    }\n\n```\n\nこの例では、`filterType`が「1」であるメッセージがSNSに送信され、そのメッセージ属性に基づいてフィルタリングが行われます。\n\n---\n\n# 3. メッセージ本文でのフィルタリング\n\nSNSではメッセージ本文の内容に基づいてもフィルタリングが可能です。次の例では、メッセージ本文内の`result.alertType`が「warn」または「error」の場合にのみメッセージを受信します。\n\n### サブスクリプションフィルターポリシー例\n\n```json\n{\n  \"result\": {\n    \"alertType\": [\n      \"error\",\n      \"warn\"\n    ]\n  }\n}\n\n```\n\n### Lambda関数の例\n\nLambda関数からメッセージを送信する際に、メッセージ本文の内容に基づいたフィルタリングが行われます。\n\n```python\nimport json\nimport boto3\n\ndef lambda_handler(event, context):\n    sns = boto3.client('sns')\n    message = {\n        'type': '1',\n        'message': 'Hello from Lambda!',\n        'key1': 'val1',\n        'key2': 'val2',\n        'result': {\n            'alertType': 'warn'\n        }\n    }\n    message_attributes = {\n        'filterType': {'DataType': 'String', 'StringValue': '1'}\n    }\n\n    response = sns.publish(\n        TopicArn='arn:aws:sns:us-east-1:9999999999:MyTopic',  # SNSトピックのARNを指定\n        Message=json.dumps(message),  # メッセージ本文\n        Subject='Test message from Lambda',  # メッセージのタイトル（オプション）\n        MessageAttributes=message_attributes\n    )\n\n    print('PublishToSns end')\n\n    return {\n        'statusCode': 200,\n        'body': json.dumps('Hello from Lambda!')\n    }\n\n```\n\nこの例では、`alertType`が「warn」であるため、このメッセージはサブスクリプションポリシーで定義されたフィルターを通過します。\n\n---\n\n# 4. まとめ\n\nSNSサブスクリプションフィルターは、特定のメッセージ属性や本文の内容に基づいて、メッセージをフィルタリングする強力なツールです。この機能を利用することで、例えば特定の警告やエラーが発生した際にのみアラートを発生させるなど、効率的な通知システムを構築できます。\n\nこの仕組みを活用することで、無駄なメッセージの受信を減らし、システムのパフォーマンスや管理の効率を向上させることが可能です。AWSのサーバーレスアーキテクチャの一環として、ぜひSNSサブスクリプションフィルターを使いこなしてみてください！！\n\n---\n","createdAt":"2025-05-19T08:50:57.240Z","updatedAt":"2025-06-05T23:51:32.943Z","publishedAt":"2025-06-05T23:51:32.956Z","docId":"ayrkvgk31u6oa8zp7ktrds2d","tags":[{"id":10,"documentId":"cxt2tbnsy05cazm17p3pp1a3","createdAt":"2025-05-19T09:46:58.860Z","updatedAt":"2025-05-19T09:46:58.860Z","publishedAt":"2025-05-19T09:46:58.868Z","name":"AWS"}],"thumbnail":[{"id":9,"documentId":"qzzy1qmpzz4j4gr38m98h3hp","name":"20250513-05.png","alternativeText":null,"caption":null,"width":1504,"height":844,"formats":{"thumbnail":{"name":"thumbnail_20250513-05.png","hash":"thumbnail_20250513_05_6c940be6e0","ext":".png","mime":"image/png","path":null,"width":245,"height":137,"size":10.98,"sizeInBytes":10981,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/thumbnail_20250513_05_6c940be6e0.png"},"large":{"name":"large_20250513-05.png","hash":"large_20250513_05_6c940be6e0","ext":".png","mime":"image/png","path":null,"width":1000,"height":561,"size":59.58,"sizeInBytes":59579,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/large_20250513_05_6c940be6e0.png"},"medium":{"name":"medium_20250513-05.png","hash":"medium_20250513_05_6c940be6e0","ext":".png","mime":"image/png","path":null,"width":750,"height":421,"size":42.52,"sizeInBytes":42523,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/medium_20250513_05_6c940be6e0.png"},"small":{"name":"small_20250513-05.png","hash":"small_20250513_05_6c940be6e0","ext":".png","mime":"image/png","path":null,"width":500,"height":281,"size":25.85,"sizeInBytes":25846,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/small_20250513_05_6c940be6e0.png"}},"hash":"20250513_05_6c940be6e0","ext":".png","mime":"image/png","size":18.18,"url":"https://stg-raisex-tech-blog.s3.ap-northeast-1.amazonaws.com/20250513_05_6c940be6e0.png","previewUrl":null,"provider":"@strapi/provider-upload-aws-s3","provider_metadata":null,"createdAt":"2025-05-20T07:42:16.763Z","updatedAt":"2025-05-20T07:42:16.763Z","publishedAt":"2025-05-20T07:42:16.764Z"}]}},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"oqg4cauzlhjjvlgo80qbb0lb"},"buildId":"wdcbjCbp8DYGqTQVAi4UF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>